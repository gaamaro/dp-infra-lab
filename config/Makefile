.PHONY: install-oneagent clean

# Vari√°veis
DYNATRACE_ENV ?= $(shell echo $$DYNATRACE_ENV)
DYNATRACE_TOKEN ?= $(shell echo $$DYNATRACE_TOKEN)
EC2_IP ?= $(shell echo $$EC2_IP)
SSH_KEY ?= /tmp/ssh_key

# Verifica se as vari√°veis necess√°rias est√£o definidas
check-env:
	@if [ -z "$(DYNATRACE_ENV)" ]; then echo "‚ùå DYNATRACE_ENV n√£o definido"; exit 1; fi
	@if [ -z "$(DYNATRACE_TOKEN)" ]; then echo "‚ùå DYNATRACE_TOKEN n√£o definido"; exit 1; fi
	@if [ -z "$(EC2_IP)" ]; then echo "‚ùå EC2_IP n√£o definido"; exit 1; fi
	@if [ ! -f "$(SSH_KEY)" ]; then echo "‚ùå Chave SSH n√£o encontrada em $(SSH_KEY)"; exit 1; fi

# Instala o OneAgent
install-oneagent: check-env
	@echo "üöÄ Iniciando instala√ß√£o do OneAgent em $(EC2_IP)..."
	@ssh -i $(SSH_KEY) -o StrictHostKeyChecking=no ubuntu@$(EC2_IP) "\
		echo 'üì• Baixando instalador do OneAgent...' && \
		wget -O Dynatrace-OneAgent-Linux-x86-latest.sh '$(DYNATRACE_ENV)/api/v1/deployment/installer/agent/unix/default/latest?arch=x86' \
			--header='Authorization: Api-Token $(DYNATRACE_TOKEN)' && \
		echo 'üîí Tornando o instalador execut√°vel...' && \
		chmod +x Dynatrace-OneAgent-Linux-x86-latest.sh && \
		echo 'üì¶ Instalando o OneAgent...' && \
		sudo ./Dynatrace-OneAgent-Linux-x86-latest.sh --set-app-log-content-access=true --set-infra-only=false --set-host-group=EC2 && \
		echo '‚úÖ OneAgent instalado com sucesso!'"

# Limpa arquivos tempor√°rios
clean:
	@echo "üßπ Limpando arquivos tempor√°rios..."
	@ssh -i $(SSH_KEY) -o StrictHostKeyChecking=no ubuntu@$(EC2_IP) "rm -f Dynatrace-OneAgent-Linux-x86-latest.sh" || true 