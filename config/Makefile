.PHONY: install-oneagent clean

# VariÃ¡veis
TENANT_ID ?= $(shell echo $$DYNATRACE_ENV | grep -o 'ogp[0-9]*')
DYNATRACE_URL ?= https://$(TENANT_ID).live.dynatrace.com
DYNATRACE_TOKEN ?= $(shell echo $$DYNATRACE_TOKEN)
EC2_IP ?= $(shell echo $$EC2_IP)
SSH_KEY ?= /tmp/ssh_key

# Verifica se as variÃ¡veis necessÃ¡rias estÃ£o definidas
check-env:
	@echo "ğŸ” Verificando variÃ¡veis de ambiente..."
	@if [ -z "$(TENANT_ID)" ]; then echo "âŒ NÃ£o foi possÃ­vel extrair TENANT_ID do DYNATRACE_ENV"; exit 1; fi
	@if [ -z "$(DYNATRACE_TOKEN)" ]; then echo "âŒ DYNATRACE_TOKEN nÃ£o definido"; exit 1; fi
	@if [ -z "$(EC2_IP)" ]; then echo "âŒ EC2_IP nÃ£o definido"; exit 1; fi
	@if [ ! -f "$(SSH_KEY)" ]; then echo "âŒ Chave SSH nÃ£o encontrada em $(SSH_KEY)"; exit 1; fi
	@echo "âœ… Todas as variÃ¡veis de ambiente estÃ£o definidas"
	@echo "ğŸ“ TENANT_ID: $(TENANT_ID)"
	@echo "ğŸ“ DYNATRACE_URL: $(DYNATRACE_URL)"
	@echo "ğŸ“ EC2_IP: $(EC2_IP)"

# Instala o OneAgent
install-oneagent: check-env
	@echo "ğŸš€ Iniciando instalaÃ§Ã£o do OneAgent em $(EC2_IP)..."
	@echo "ğŸ“¥ URL do instalador: $(DYNATRACE_URL)/api/v1/deployment/installer/agent/unix/default/latest?arch=x86"
	@ssh -i $(SSH_KEY) -o StrictHostKeyChecking=no ubuntu@$(EC2_IP) "\
		echo 'ğŸ“¥ Baixando instalador do OneAgent...' && \
		wget -O Dynatrace-OneAgent-Linux-x86-latest.sh '$(DYNATRACE_URL)/api/v1/deployment/installer/agent/unix/default/latest?arch=x86' \
			--header='Authorization: Api-Token $(DYNATRACE_TOKEN)' && \
		echo 'ğŸ”’ Tornando o instalador executÃ¡vel...' && \
		chmod +x Dynatrace-OneAgent-Linux-x86-latest.sh && \
		echo 'ğŸ“¦ Instalando o OneAgent...' && \
		sudo ./Dynatrace-OneAgent-Linux-x86-latest.sh --set-app-log-content-access=true --set-infra-only=false --set-host-group=EC2 && \
		echo 'âœ… OneAgent instalado com sucesso!'"

# Limpa arquivos temporÃ¡rios
clean:
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	@ssh -i $(SSH_KEY) -o StrictHostKeyChecking=no ubuntu@$(EC2_IP) "rm -f Dynatrace-OneAgent-Linux-x86-latest.sh" || true 